# Copyright (c) Facebook, Inc. and its affiliates.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

on:
  workflow_run:
    workflows: ["Linux Benchmark"]
    types:
      - completed

permissions:
  contents: read
  #TODO comment results to PR

jobs:
  upload:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:

    - uses: actions/download-artifact@v3
      with:
        path: "benchmark-results"
        name: "benchmark-results"
    
    - uses: actions/download-artifact@v3
      with:
        path: "info"
        name: "info"

    - uses: actions/checkout@v3
      with:
        path: velox
    - uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        cache: 'pip'
    
    - name: "Install dependencies"
      run: python -m pip install -r velox/scripts/benchmark-requirements.txt

    - name: "Extract PR info"
      id: info
      run: |
        echo "::set-output name=pr_number::$(cat info/pr_number.txt)"
        echo "::set-output name=sha::$(cat info/sha.txt)"
    
    - name: "Upload results"
      env:
        CONBENCH_URL: "https://velox-conbench.voltrondata.run/"
        CONBENCH_HOST: "GitHub-runner"
        CONBENCH_EMAIL: ${{ secrets.CONBENCH_EMAIL }}
        CONBENCH_PASSWORD: ${{ secrets.CONBENCH_PASSWORD }}
      run: |
        ./velox/scripts/benchmark-runner.py upload \
          --run_id "GHA-${{ github.run_id }}-${{ github.run_attempt }}" \
          --pr_number "${{ steps.info.outputs.pr_number }} \
          --sha "${{ steps.info.outputs.sha }}" \
          --results_root "${{ github.workspace }}/benchmark-results/target/"
